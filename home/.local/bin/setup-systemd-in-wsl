#!/bin/bash

# adapted from ubuntu-wsl2-systemd-script.sh

if [[ -z "$WSL_DISTRO_NAME" && "$1" != "--force" ]]; then
  echo "It appears you are not running inside a WSL distro"
  echo "To forcibly install, run this script with the \`--force\` ."
  exit 1
fi

if [[ -f /usr/sbin/start-systemd-namespace && "$1" != "--force" ]]; then
  echo "It appears you have already installed the systemd hack."
  echo "To forcibly reinstall, run this script with the \`--force\` parameter."
  exit
fi

self_dir="$HOME/.homesick/repos/dotfiles/submodules/ubuntu-wsl2-systemd-script"

if [[ ! -d "$self_dir" ]]; then
  echo "Could not find installation files in $self_dir"
  exit 1
fi

sudo apt-get update && sudo apt-get install -yqq daemonize dbus-user-session fontconfig

sudo cp "$self_dir/start-systemd-namespace" /usr/sbin/start-systemd-namespace
sudo cp "$self_dir/enter-systemd-namespace" /usr/sbin/enter-systemd-namespace
sudo chmod +x /usr/sbin/enter-systemd-namespace

sudo tee /etc/sudoers.d/systemd-namespace > /dev/null <<EOF
Defaults        env_keep += WSLPATH
Defaults        env_keep += WSLENV
Defaults        env_keep += WSL_INTEROP
Defaults        env_keep += WSL_DISTRO_NAME
Defaults        env_keep += PRE_NAMESPACE_PATH
Defaults        env_keep += PRE_NAMESPACE_PWD
%sudo ALL=(ALL) NOPASSWD: /usr/sbin/enter-systemd-namespace
EOF

# if [[ -f /proc/sys/fs/binfmt_misc/WSLInterop && "$(head -n1  /proc/sys/fs/binfmt_misc/WSLInterop)" == "enabled" ]]; then
#   cmd.exe /C setx WSLENV BASH_ENV/u
#   cmd.exe /C setx BASH_ENV /etc/bash.bashrc
# fi
